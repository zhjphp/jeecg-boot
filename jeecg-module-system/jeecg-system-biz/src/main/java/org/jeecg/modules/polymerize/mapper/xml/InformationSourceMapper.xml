<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.polymerize.mapper.InformationSourceMapper">

<!--    <select id="selectInformationSourceByCategoryId" resultType="org.jeecg.modules.polymerize.entity.InformationSource">-->
<!--        SELECT pis.* FROM polymerize_information_source AS pis LEFT JOIN polymerize_information_source_category AS pisc ON pis.id = pisc.information_source_id WHERE pisc.category_id = #{categoryId} ORDER BY pis.rank DESC, pis.create_time DESC-->
<!--    </select>-->

<!--    <select id="selectInformationSourceByCategoryId" resultType="org.jeecg.modules.polymerize.entity.InformationSource">-->
<!--        SELECT-->
<!--            pis.*,-->
<!--            GROUP_CONCAT(pisc.category_id) as category_ids-->
<!--        FROM polymerize_information_source AS pis-->
<!--            LEFT JOIN-->
<!--            polymerize_information_source_category AS pisc-->
<!--                ON pis.id = pisc.information_source_id-->
<!--        WHERE-->
<!--        <if test="query != null">-->
<!--            <foreach collection="query.entrySet()" item="value" index="key">-->
<!--                and ${key} = #{value}-->
<!--            </foreach>-->
<!--        </if>-->
<!--    </select>-->

<!--    <select id="selectInformationSourceByCategoryId" resultType="org.jeecg.modules.polymerize.vo.InformationSourceVO">-->
<!--        SELECT pis.*, GROUP_CONCAT(pisc.category_id) as category_ids FROM `polymerize_information_source` AS pis LEFT JOIN `polymerize_information_source_category` AS pisc ON pis.id = pisc.information_source_id where pis.`name` like "%3%" GROUP BY pis.id-->
<!--    </select>-->

<!--    <select id="selectInformationSourceByCategoryId" resultType="org.jeecg.modules.polymerize.vo.InformationSourceVO">-->
<!--        SELECT tmp1.*, GROUP_CONCAT(tmp2.category_id) as category_ids from-->
<!--            (select pis.* from `polymerize_information_source` AS pis LEFT JOIN polymerize_information_source_category as pisc ON pis.id = pisc.information_source_id where pisc.category_id = "1648882679229452289" and pis.`name` LIKE '%ç™¾%') as tmp1-->
<!--                LEFT JOIN-->
<!--            (select pisc2.category_id, pisc2.information_source_id from `polymerize_information_source_category` AS pisc2 ) AS tmp2 ON tmp1.id = tmp2.information_source_id-->
<!--        GROUP BY tmp1.id-->
<!--    </select>-->

    <select id="selectInformationSource" resultType="org.jeecg.modules.polymerize.vo.InformationSourceVO">
        <choose>
            <when test='informationSourceDTO.categoryId != null and informationSourceDTO.categoryId != ""'>
                SELECT
                    tmp1.*, GROUP_CONCAT(tmp2.category_id) as category_ids
                FROM
                (SELECT
                     pis.*
                 FROM
                     polymerize_information_source AS pis
                         LEFT JOIN polymerize_information_source_category AS pisc
                             ON
                                 pis.id = pisc.information_source_id
                 WHERE
                     pisc.category_id = #{informationSourceDTO.categoryId}
                   AND pis.del_flag = 0
                <if test='informationSourceDTO.id != null and informationSourceDTO.id != ""'>
                    AND pis.id = #{informationSourceDTO.id}
                </if>
                <if test='informationSourceDTO.name != null and informationSourceDTO.name != ""'>
                    <bind name="bindName" value="'%'+informationSourceDTO.name+'%'"/>
                    AND pis.name like #{bindName}
                </if>
                <if test='informationSourceDTO.domain != null and informationSourceDTO.domain != ""'>
                    <bind name="bindDomain" value="'%'+informationSourceDTO.domain+'%'"/>
                    AND pis.domain like #{bindDomain}
                </if>
                <if test='informationSourceDTO.scheme != null and informationSourceDTO.scheme != ""'>
                    AND pis.scheme = #{informationSourceDTO.scheme}
                </if>
                <if test='informationSourceDTO.port != null'>
                    AND pis.port = #{informationSourceDTO.port}
                </if>
                 )
                    AS tmp1
                LEFT JOIN
                (SELECT
                     pisc2.category_id, pisc2.information_source_id
                 FROM
                     polymerize_information_source_category AS pisc2 ) AS tmp2
                    ON tmp1.id = tmp2.information_source_id
                GROUP BY tmp1.id

            </when>
            <otherwise>
                SELECT
                    pis.*, GROUP_CONCAT(pisc.category_id) AS category_ids
                FROM
                    polymerize_information_source AS pis
                        LEFT JOIN
                        polymerize_information_source_category AS pisc
                            ON pis.id = pisc.information_source_id
                WHERE pis.del_flag = 0
                <if test='informationSourceDTO.id != null and informationSourceDTO.id != ""'>
                    AND pis.id = #{informationSourceDTO.id}
                </if>
                <if test='informationSourceDTO.name != null and informationSourceDTO.name != ""'>
                    <bind name="bindName" value="'%'+informationSourceDTO.name+'%'"/>
                    AND pis.name like #{bindName}
                </if>
                <if test='informationSourceDTO.domain != null and informationSourceDTO.domain != ""'>
                    <bind name="bindDomain" value="'%'+informationSourceDTO.domain+'%'"/>
                    AND pis.domain like #{bindDomain}
                </if>
                <if test='informationSourceDTO.scheme != null and informationSourceDTO.scheme != ""'>
                    AND pis.scheme = #{informationSourceDTO.scheme}
                </if>
                <if test='informationSourceDTO.port != null'>
                    AND pis.port = #{informationSourceDTO.port}
                </if>
                GROUP BY pis.id
                ORDER BY pis.rank DESC, pis.create_time DESC
            </otherwise>
        </choose>
    </select>

    <select id="selectByComponentData" resultType="org.jeecg.modules.polymerize.vo.InformationSourceVO">
        <choose>
            <when test='informationSourceDTO.categoryId != null and informationSourceDTO.categoryId != ""'>
                SELECT
                tmp1.*, GROUP_CONCAT(tmp2.category_id) as category_ids
                FROM
                (SELECT
                pis.*
                FROM
                polymerize_information_source AS pis
                LEFT JOIN polymerize_information_source_category AS pisc
                ON
                pis.id = pisc.information_source_id
                WHERE
                pisc.category_id = #{informationSourceDTO.categoryId}
                AND pis.del_flag = 0
                <if test='informationSourceDTO.id != null and informationSourceDTO.id != ""'>
                    AND pis.id = #{informationSourceDTO.id}
                </if>
                <if test='informationSourceDTO.name != null and informationSourceDTO.name != ""'>
                    <bind name="bindName" value="'%'+informationSourceDTO.name+'%'"/>
                    AND pis.name like #{bindName}
                </if>
                <if test='informationSourceDTO.domain != null and informationSourceDTO.domain != ""'>
                    <bind name="bindDomain" value="'%'+informationSourceDTO.domain+'%'"/>
                    AND pis.domain like #{bindDomain}
                </if>
                <if test='informationSourceDTO.scheme != null and informationSourceDTO.scheme != ""'>
                    AND pis.scheme = #{informationSourceDTO.scheme}
                </if>
                <if test='informationSourceDTO.port != null'>
                    AND pis.port = #{informationSourceDTO.port}
                </if>
                )
                AS tmp1
                LEFT JOIN
                (SELECT
                pisc2.category_id, pisc2.information_source_id
                FROM
                polymerize_information_source_category AS pisc2 ) AS tmp2
                ON tmp1.id = tmp2.information_source_id
                GROUP BY tmp1.id

            </when>
            <otherwise>
                SELECT
                pis.*, GROUP_CONCAT(pisc.category_id) AS category_ids
                FROM
                polymerize_information_source AS pis
                LEFT JOIN
                polymerize_information_source_category AS pisc
                ON pis.id = pisc.information_source_id
                WHERE pis.del_flag = 0
                <if test='idArray != null and idArray.length > 0'>
                    AND pis.id IN
                    <foreach item="id" collection="idArray"  open="(" separator="," close=")">
                        #{id}
                    </foreach>
                </if>
                <if test='informationSourceDTO.name != null and informationSourceDTO.name != ""'>
                    <bind name="bindName" value="'%'+informationSourceDTO.name+'%'"/>
                    AND pis.name like #{bindName}
                </if>
                <if test='informationSourceDTO.domain != null and informationSourceDTO.domain != ""'>
                    <bind name="bindDomain" value="'%'+informationSourceDTO.domain+'%'"/>
                    AND pis.domain like #{bindDomain}
                </if>
                <if test='informationSourceDTO.scheme != null and informationSourceDTO.scheme != ""'>
                    AND pis.scheme = #{informationSourceDTO.scheme}
                </if>
                <if test='informationSourceDTO.port != null'>
                    AND pis.port = #{informationSourceDTO.port}
                </if>
                GROUP BY pis.id
                ORDER BY pis.rank DESC, pis.create_time DESC
            </otherwise>
        </choose>
    </select>

</mapper>